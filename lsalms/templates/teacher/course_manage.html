{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load lsalms_extras %}

{% block title %}AI Course Builder: {{ course.get_course_title }}{% endblock %}

{% block extra_head %}
<style>
    /* === Top-Notch Builder Styles === */
    .builder-header {
        background-color: #fff;
        padding: 1.5rem 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 25px rgba(0,0,0,0.07);
        margin-bottom: 2rem;
    }
    .builder-nav .nav-link {
        font-weight: 500;
        color: #6c757d;
        padding: 0.75rem 1.5rem;
        border-bottom: 3px solid transparent;
    }
    .builder-nav .nav-link.active {
        color: var(--bs-primary);
        border-bottom-color: var(--bs-primary);
        background-color: transparent;
    }
    .module-accordion .accordion-item {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem !important; /* Override Bootstrap's default */
        overflow: hidden;
    }
    .module-accordion .accordion-button {
        font-weight: 600;
        font-size: 1.1rem;
        background-color: #f8f9fa;
    }
    .module-accordion .accordion-button:not(.collapsed) {
        color: var(--bs-primary);
        box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
    }
    .lesson-item {
        padding: 1rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .lesson-item:last-child { border-bottom: none; }
    .content-block-list {
        list-style-type: none;
        padding-left: 2.5rem;
        margin-top: 1rem;
    }
    .action-btn { background: none; border: none; padding: 0.25rem 0.5rem; color: #6c757d; }
    .ai-suggestion-box { background-color: #eef2ff; border: 1px dashed #b0c4ff; padding: 1.5rem; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

{% endblock %}


{% block content %}
<div class="container-fluid my-4">
    {{ content_form.media }}
    <!-- === Dedicated Header Section === -->
    <div class="builder-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1 class="h2 fw-bold mb-1">{{ course.get_course_title }} <span class="badge bg-secondary">{{ course.get_status_display }}</span></h1>
                <p class="text-muted mb-0">Your AI-powered course creation workspace.</p>
            </div>
            <div>
                {% if course.status == 'DRAFT' %}
                    <form action="{% url 'lsalms:course_publish' pk=course.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success"><i class="fas fa-rocket me-1"></i> Publish Course</button>
                    </form>
                {% endif %}
                <a href="{% url 'lsalms:course_edit' slug=course.slug %}" class="btn btn-outline-secondary"><i class="fas fa-cog me-1"></i> Settings & Grading</a>
                <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary"><i class="fas fa-times me-1"></i> Close Builder</a>
            </div>
        </div>
    </div>

    <!-- === Main Tab Navigation === -->
    <ul class="nav nav-pills mb-4" id="builderTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum-panel" type="button" role="tab">
                <i class="fas fa-sitemap me-2"></i>Curriculum
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress-panel" type="button" role="tab">
                <i class="fas fa-chart-line me-2"></i>Student Progress
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="builderTabContent">
        <!-- === Curriculum & Stats Panel (REBUILT) === -->
        <div class="tab-pane fade show active" id="curriculum-panel" role="tabpanel">
            <div class="row g-4">
                <!-- Left Column: Curriculum Structure -->
                <!-- Left Column: Curriculum Structure -->
                <div class="col-lg-8">
                    {% for module in course.modules.all %}
                        <div class="accordion module-accordion mb-3" id="accordionModule{{ module.pk }}">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingModule{{ module.pk }}">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseModule{{ module.pk }}">
                                        {{ module.title }}
                                    </button>
                                </h2>
                                <div id="collapseModule{{ module.pk }}" class="accordion-collapse collapse show">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-end mb-3">
                                            <button class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:module_edit' pk=module.pk %}" title="Edit Module"><i class="fas fa-pencil-alt me-1"></i> Edit Module</button>
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-url="{% url 'lsalms:module_delete' pk=module.pk %}" data-name="{{ module.title }}" title="Delete Module"><i class="fas fa-trash-alt me-1"></i> Delete Module</button>
                                        </div>
                                        
                                        {% for lesson in module.lessons.all %}
                                            <div class="lesson-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h6 class="fw-bold mb-0"><i class="fas fa-file-alt fa-fw text-muted me-2"></i>{{ lesson.title }}</h6>
                                                    <div>
                                                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:content_block_create' lesson_id=lesson.id %}">Add Content</button>
                                                        <button class="action-btn ms-2" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:lesson_edit' pk=lesson.pk %}" title="Edit Lesson"><i class="fas fa-pencil-alt"></i></button>
                                                        <button class="action-btn action-btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal" data-url="{% url 'lsalms:lesson_delete' pk=lesson.pk %}" data-name="{{ lesson.title }}" title="Delete Lesson"><i class="fas fa-trash-alt"></i></button>
                                                    </div>
                                                </div>
                                                <ul class="content-block-list">
                                                    {% for block in lesson.content_blocks.all %}
                                                        <li class="content-block-item d-flex justify-content-between align-items-center">
                                                            <span><i class="fas fa-puzzle-piece fa-fw text-muted me-2"></i>{{ block.title }}</span>
                                                            <div>
                                                                <button class="action-btn" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:content_block_edit' pk=block.pk %}" title="Edit Content"><i class="fas fa-pencil-alt"></i></button>
                                                                <button class="action-btn action-btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal" data-url="{% url 'lsalms:content_block_delete' pk=block.pk %}" data-name="{{ block.title }}" title="Delete Content"><i class="fas fa-trash-alt"></i></button>
                                                            </div>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endfor %}
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:lesson_create' module_id=module.id %}"><i class="fas fa-plus me-1"></i> Add Lesson</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center p-5 bg-light rounded ai-suggestion-box">
                            <h5 class="fw-bold">Let's build your course!</h5>
                            <p class="text-muted">Need a starting point? Our AI can suggest a course outline for you.</p>
                            
                            {% if AI_IS_CONFIGURED %}
                                <button type="button" class="btn btn-primary ai-assist-btn" data-target="initial-module-suggestions" data-prompt-source="static" data-prompt="Based on the course title and its learning objectives, suggest 4-5 relevant module titles. Return them as a simple, unnumbered list, one per line." data-context="Course Title: '{{ course.title }}'. Learning Objectives: '{{ course.learning_objectives }}'"><i class="fas fa-magic me-2"></i> Suggest Course Outline</button>
                                <div id="initial-module-suggestions" class="mt-3 text-start"></div>
                            {% else %}
                                <div class="alert alert-warning small mt-3">
                                    <strong>AI Assistant is not configured.</strong> A `GEMINI_API_KEY` is missing from the application's environment settings. This feature is currently disabled.
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div class="mt-4 d-flex justify-content-center">
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#editModal" data-url="{% url 'lsalms:module_create' course_id=course.pk %}">
                            <i class="fas fa-plus me-1"></i> Add New Module
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Stats (RESTORED) -->
                <div class="col-lg-4">
                    <div class="card shadow-sm position-sticky" style="top: 80px;">
                         <div class="card-header bg-light"><h5 class="mb-0">Course at a Glance</h5></div>
                         <div class="card-body">
                             <ul class="list-group list-group-flush">
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Modules<span class="badge bg-primary rounded-pill">{{ course.modules.count }}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Total Lessons<span class="badge bg-primary rounded-pill">{% get_total_lesson_count course %}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Status<span class="badge bg-info rounded-pill">{{ course.get_status_display }}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Enrolled Students<span class="badge bg-secondary rounded-pill">{{ student_progress_data|length }}</span></li>
                             </ul>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Progress Panel -->
        <div class="tab-pane fade" id="progress-panel" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Student Engagement & Progress</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Tracking {{ student_progress_data|length }} enrolled student(s).</p>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Progress</th>
                                    <th class="text-center">Lessons Completed</th>
                                    <th class="text-center">Final Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in student_progress_data %}
                                    <tr>
                                        <td><strong>{{ enrollment.student.user.get_full_name }}</strong></td>
                                        <td>
                                            <div class="progress" title="{{ enrollment.progress_percentage }}% Complete">
                                                <div class="progress-bar" role="progressbar" style="width: {{ enrollment.progress_percentage }}%;" aria-valuenow="{{ enrollment.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">{{ enrollment.progress_percentage }}%</div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            {{ enrollment.completed_lessons_count|default:0 }} / {{ total_lessons_in_course }}
                                        </td>
                                        <td class="text-center">
                                            {% if enrollment.grade_report and enrollment.grade_report.final_score is not None %}
                                                <span class="badge bg-primary rounded-pill fs-6">{{ enrollment.grade_report.final_score|floatformat:0 }}%</span>
                                            {% else %}
                                                <span class="text-muted small">N/A</span>
                                            {% endif %}
                                        </td>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">No students are currently enrolled in this course.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === MODALS (Generic and Reusable) === -->
<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"></div></div></div>
<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><p>Are you sure you want to delete <strong id="deleteObjectName">this item</strong>? This action cannot be undone.</p></div>
    <div class="modal-footer"><form id="deleteForm" method="post">{% csrf_token %}<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-danger">Yes, Delete</button></form></div>
</div></div></div>
{% endblock %}


{% block extra_js %}
<script>
  const moduleList = document.getElementById('module-list');
  const sortable = new Sortable(moduleList, {
    animation: 150,
    handle: '.card-header', // Optional: makes only the header draggable
    onEnd: function (evt) {
      const orderedIds = Array.from(moduleList.children).map(child => child.dataset.id);

      // Use fetch API to send the new order to the backend
      const formData = new FormData();
      orderedIds.forEach(id => formData.append('module_order[]', id));

      fetch("{% url 'lsalms:update_module_order' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}', // Django CSRF protection
        },
        body: formData
      });
    }
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // This variable is correctly passed from the Django view.
    // It will be either `true` or `false` in the final rendered HTML.
    const AI_IS_CONFIGURED = {{ AI_IS_CONFIGURED|yesno:"true,false" }};

    // --- Generic Modal Loaders for Edit & Create forms ---
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const url = button.getAttribute('data-url');
            const modalContent = editModal.querySelector('.modal-content');
            if(url) {
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                        // After loading the form, re-initialize the dynamic fields
                        initializeDynamicFormFields(modalContent);
                    });
            }
        });
    }

    // --- Generic Modal Loader for DELETE confirmation ---
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        // ... (this part is correct and remains the same)
    }

    // === NEW CENTRALIZED FUNCTION FOR DYNAMIC MODAL CONTENT ===
    function initializeDynamicFormFields(modalContent) {
        // This function is called every time a new form is loaded into a modal.
        
        // --- Logic for the Dynamic ContentBlock Form ---
        const contentTypeSelect = modalContent.querySelector('[id$="-content_type"]'); // Finds the select regardless of prefix
        if (contentTypeSelect) {
            const aiCopilotWrapper = modalContent.querySelector('#ai-copilot-wrapper');
            const fieldTypeMap = {
                'rich_text': ['TEXT'],
                'media_url': ['VIDEO'],
                'media_file': ['IMAGE', 'AUDIO', 'FILE'],
                'linked_practice_quiz': ['PRACTICE_QUIZ'],
                'linked_assignment': ['ASSIGNMENT'],
                'linked_assessment': ['ASSESSMENT'],
                'linked_exam': ['EXAM']
            };

            function toggleContentFields() {
                const selectedType = contentTypeSelect.value;
                for (const fieldName in fieldTypeMap) {
                    const fieldElement = modalContent.querySelector(`[id$="-${fieldName}"]`);
                    if (fieldElement) {
                        const parentWrapper = fieldElement.closest('div.mb-3');
                        if (parentWrapper) {
                            parentWrapper.style.display = fieldTypeMap[fieldName].includes(selectedType) ? 'block' : 'none';
                        }
                    }
                }
                // --- THE AI VISIBILITY FIX ---
                // We check the global config flag AND the selected content type.
                if (aiCopilotWrapper) {
                    aiCopilotWrapper.style.display = (selectedType === 'TEXT' && AI_IS_CONFIGURED) ? 'block' : 'none';
                }
            }
            contentTypeSelect.addEventListener('change', toggleContentFields);
            toggleContentFields(); // Run once to set initial state
        }
    }

    // --- AI Assist Button Logic using EVENT DELEGATION ---
    // This is more robust because it listens on a parent element.
    if (AI_IS_CONFIGURED) {
        document.body.addEventListener('click', function(event) {
            // Check if the clicked element is our AI button
            if (event.target.matches('.ai-assist-btn')) {
                const button = event.target;
                const promptSourceType = button.dataset.promptSource;
                let promptText;

                if (promptSourceType === 'static') {
                    promptText = button.dataset.prompt;
                } else {
                    const promptTextarea = document.getElementById(promptSourceType);
                    if (!promptTextarea) { console.error('AI prompt source not found'); return; }
                    promptText = promptTextarea.value;
                }
                
                const targetElementId = button.dataset.target;
                const contextText = button.dataset.context;
                const targetElement = document.getElementById(targetElementId);
                
                if (!promptText.trim() || !targetElement) { console.error('AI target or prompt is missing'); return; }
                
                const originalButtonText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Thinking...`;
                
                const formData = new FormData();
                formData.append('prompt', promptText);
                formData.append('context', contextText);
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'lsalms:api_ai_assist' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok) { throw new Error(data.error || 'Server error'); }
                    if (targetElement.nodeName === 'TEXTAREA' || targetElement.nodeName === 'INPUT') {
                        targetElement.value = data.generated_text;
                    } else {
                        const items = data.generated_text.split('\n').filter(item => item.trim() !== '');
                        let html = '<ul class="list-unstyled">';
                        items.forEach(item => {
                            html += `<li><i class="fas fa-check-circle text-success me-2"></i>${item.trim()}</li>`;
                        });
                        html += '</ul>';
                        targetElement.innerHTML = html;
                    }
                })
                .catch(error => { alert(`An AI error occurred: ${error.message}`); })
                .finally(() => { button.disabled = false; button.innerHTML = originalButtonText; });
            }
        });
    }
});
</script>
{% endblock %}