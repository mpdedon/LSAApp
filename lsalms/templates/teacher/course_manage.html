{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load lsalms_extras %}

{% block title %}Course Builder: {{ course.get_course_title }}{% endblock %}

{% block extra_head %}
<style>
    /* === Top-Notch Builder Styles === */
    .builder-header { background-color: #fff; padding: 1.5rem 2rem; border-radius: 0.75rem; box-shadow: 0 4px 25px rgba(0,0,0,0.07); margin-bottom: 2rem; }
    .builder-nav .nav-link { font-weight: 500; color: #6c757d; padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; }
    .builder-nav .nav-link.active { color: var(--bs-primary); border-bottom-color: var(--bs-primary); background-color: transparent; }
    .module-accordion .accordion-item { border: 1px solid #dee2e6; border-radius: 0.5rem !important; overflow: hidden; }
    .module-accordion .accordion-button { font-weight: 600; font-size: 1.1rem; background-color: #f8f9fa; }
    .module-accordion .accordion-button:not(.collapsed) { color: var(--bs-primary); box-shadow: inset 0 -1px 0 rgba(0,0,0,.125); }
    .lesson-item { padding: 1rem; border-bottom: 1px solid #e9ecef; }
    .lesson-item:last-child { border-bottom: none; }
    .content-block-list { list-style-type: none; padding-left: 2.5rem; margin-top: 1rem; }
    .action-btn { background: none; border: none; padding: 0.25rem 0.5rem; color: #6c757d; }
    
    /* --- Styles for Drag & Drop --- */
    .drag-handle { cursor: grab; opacity: 0.5; transition: opacity 0.2s; }
    .drag-handle:hover { opacity: 1; }
    .sortable-ghost { opacity: 0.4; background: #c8ebfb; } /* Visual feedback for drop location */
    .sortable-chosen { cursor: grabbing; }
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
{% endblock %}


{% block content %}
<div class="container-fluid my-4">
    <!-- === Dedicated Header Section === -->
    <div class="builder-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1 class="h2 fw-bold mb-1">{{ course.get_course_title }} <span class="badge bg-secondary">{{ course.get_status_display }}</span></h1>
                <p class="text-muted mb-0">Your AI-powered course creation workspace.</p>
            </div>
            <div>
                {% if course.status == 'DRAFT' %}
                    <form action="{% url 'lsalms:course_publish' pk=course.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success"><i class="fas fa-rocket me-1"></i> Publish Course</button>
                    </form>
                {% endif %}
                <a href="{% url 'lsalms:course_edit' slug=course.slug %}" class="btn btn-outline-secondary"><i class="fas fa-cog me-1"></i> Settings & Grading</a>
                <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary"><i class="fas fa-times me-1"></i> Close Builder</a>
            </div>
        </div>
    </div>

    <!-- === Main Tab Navigation === -->
    <ul class="nav nav-pills builder-nav mb-4" id="builderTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum-panel" type="button" role="tab">
                <i class="fas fa-sitemap me-2"></i>Curriculum
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress-panel" type="button" role="tab">
                <i class="fas fa-chart-line me-2"></i>Student Progress
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="builderTabContent">
        <!-- === Curriculum Panel === -->
        <div class="tab-pane fade show active" id="curriculum-panel" role="tabpanel">
            <div class="row g-4">
                <!-- Left Column: The Interactive Curriculum -->
                <div class="col-lg-8" id="curriculum-container">
                    
                    <!-- This is the main container for draggable modules -->
                    <div id="modules-list" data-reorder-url="{% url 'lsalms:api_update_module_order' course_id=course.pk %}">
                        {% for module in course.modules.all %}
                            {% include 'teacher/partials/_module_item.html' with module=module %}
                        {% endfor %}
                    </div>

                    {% if not course.modules.all %}
                        <div class="text-center p-5 bg-light rounded ai-suggestion-box">
                            <h5 class="fw-bold">Let's build your course!</h5>
                            <p class="text-muted">This course has no modules yet. Add your first one below, or use AI to get started.</p>
                            {% if AI_IS_CONFIGURED %}
                                <button type="button" class="btn btn-primary ai-assist-btn" data-target="initial-module-suggestions" ...>...</button>
                                <div id="initial-module-suggestions" class="mt-3 text-start"></div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="mt-4 d-flex justify-content-center">
                        <button type="button" class="btn btn-primary btn-lg modal-btn" data-bs-toggle="modal" data-bs-target="#simpleModal" data-url="{% url 'lsalms:module_create' course_id=course.pk %}">
                            <i class="fas fa-plus me-1"></i> Add New Module
                        </button>
                    </div>
                </div>
                
                <!-- ... Your Right Column for Stats ... -->
                <div class="col-lg-4">
                    <div class="card shadow-sm position-sticky" style="top: 80px;">
                         <div class="card-header bg-light"><h5 class="mb-0">Course at a Glance</h5></div>
                         <div class="card-body">
                             <ul class="list-group list-group-flush">
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Modules<span class="badge bg-primary rounded-pill">{{ course.modules.count }}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Total Lessons<span class="badge bg-primary rounded-pill">{% get_total_lesson_count course %}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Status<span class="badge bg-info rounded-pill">{{ course.get_status_display }}</span></li>
                                 <li class="list-group-item d-flex justify-content-between align-items-center">Enrolled Students<span class="badge bg-secondary rounded-pill">{{ student_progress_data|length }}</span></li>
                             </ul>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ... Your Student Progress Panel ... -->
        <div class="tab-pane fade" id="progress-panel" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Student Engagement & Progress</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Tracking {{ student_progress_data|length }} enrolled student(s).</p>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Progress</th>
                                    <th class="text-center">Lessons Completed</th>
                                    <th class="text-center">Final Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in student_progress_data %}
                                    <tr>
                                        <td><strong>{{ enrollment.student.user.get_full_name }}</strong></td>
                                        <td>
                                            <div class="progress" title="{{ enrollment.progress_percentage }}% Complete">
                                                <div class="progress-bar" role="progressbar" style="width: {{ enrollment.progress_percentage }}%;" aria-valuenow="{{ enrollment.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">{{ enrollment.progress_percentage }}%</div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            {{ enrollment.completed_lessons_count|default:0 }} / {{ total_lessons_in_course }}
                                        </td>
                                        <td class="text-center">
                                            {% if enrollment.grade_report and enrollment.grade_report.final_score is not None %}
                                                <span class="badge bg-primary rounded-pill fs-6">{{ enrollment.grade_report.final_score|floatformat:0 }}%</span>
                                            {% else %}
                                                <span class="text-muted small">N/A</span>
                                            {% endif %}
                                        </td>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">No students are currently enrolled in this course.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === MODALS === -->
<!-- Simple modal for Module & Lesson forms -->
<div class="modal fade" id="simpleModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"></div></div></div>
<!-- Large modal for complex ContentBlock forms -->
<div class="modal fade" id="formModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"></div></div></div>
<!-- Delete confirmation modal -->
<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><p>Are you sure you want to delete <strong id="deleteObjectName">this item</strong>? This action cannot be undone.</p></div>
    <div class="modal-footer"><form id="deleteForm" method="post">{% csrf_token %}<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-danger">Delete</button></form></div>
</div></div></div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 1. SETUP & CONFIGURATION ---
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const curriculumContainer = document.getElementById('curriculum-container');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const AI_IS_CONFIGURED = {{ AI_IS_CONFIGURED|yesno:"true,false" }};


    // --- 2. CORE DYNAMIC SCRIPT INITIALIZATION ENGINE ---
    /**
     * This function is called every time new HTML is loaded into a modal.
     */
    function reinitializeModalScripts(modalContent) {
        
        // ================= START: THE ALPINE.JS v3 FIX =================
        // In Alpine v3, you don't need to manually initialize components.
        // The `defer` attribute on the script tag handles the initial load.
        // For dynamically added content, Alpine automatically discovers it.
        // We can simply dispatch a custom event if needed, but often it's not.
        // This function's main job is now just to handle CKEditor.
        // =================  END: THE ALPINE.JS v3 FIX  =================

        // B. Initialize CKEditor for any rich text textareas
        const ckeditorTextarea = modalContent.querySelector('textarea.ckeditor-textarea');
        if (ckeditorTextarea && typeof ClassicEditor !== 'undefined') {
            if (ckeditorTextarea.ckeditorInstance) {
                ckeditorTextarea.ckeditorInstance.destroy().catch(() => {});
            }
            ClassicEditor
                .create(ckeditorTextarea)
                .then(editor => {
                    ckeditorTextarea.ckeditorInstance = editor;
                })
                .catch(error => console.error('CKEditor Init Error:', error));
        }
    }


    // --- 3. DRAG-AND-DROP REORDERING ENGINE (SortableJS) ---
    function sendReorderRequest(url, listElement, idKey) {
        const orderedIds = Array.from(listElement.children).map(child => child.dataset.id).filter(id => id);
        if (orderedIds.length === 0) return;
        const formData = new FormData();
        orderedIds.forEach(id => formData.append(`${idKey}[]`, id));
        fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData });
    }

    function initializeSortable(selector, idKey) {
        document.querySelectorAll(selector).forEach(list => {
            if (list.sortableInstance) list.sortableInstance.destroy();
            list.sortableInstance = new Sortable(list, {
                animation: 150, handle: '.drag-handle',
                ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                onEnd: () => sendReorderRequest(list.dataset.reorderUrl, list, idKey)
            });
        });
    }

    function initializeAllSortables() {
        initializeSortable('#modules-list', 'module_order');
        initializeSortable('.lessons-list', 'lesson_order');
        initializeSortable('.content-blocks-list', 'block_order');
    }
    initializeAllSortables();


    // --- 4. AJAX INTERACTIONS ENGINE (MODALS FOR CREATE, EDIT, DELETE) ---
    document.body.addEventListener('click', function(event) {
        const modalBtn = event.target.closest('.modal-btn');
        const deleteBtn = event.target.closest('.delete-btn');

        // -- Handle opening Create/Edit Modals --
        if (modalBtn) {
            event.preventDefault();
            const modalEl = document.querySelector(modalBtn.dataset.bsTarget);
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            const modalContent = modalEl.querySelector('.modal-content');
            
            fetch(modalBtn.dataset.url)
                .then(response => response.text())
                .then(html => {
                    modalContent.innerHTML = html;
                    modalInstance.show();
                    modalEl.addEventListener('shown.bs.modal', () => {
                        reinitializeModalScripts(modalContent);
                    }, { once: true });
                });
        }
        
        // -- Handle opening Delete Modals --
        if (deleteBtn) {
            event.preventDefault();
            document.getElementById('deleteObjectName').textContent = `"${deleteBtn.dataset.name}"`;
            const deleteForm = document.getElementById('deleteForm');
            deleteForm.action = deleteBtn.dataset.url;
            deleteForm.dataset.itemToRemove = `#${deleteBtn.closest('[data-id]').id}`;
            deleteModal.show();
        }
    });

    // --- 4. AJAX INTERACTIONS ENGINE (with enhanced logging) ---
    document.body.addEventListener('click', function(event) {
        // ... (Your 'modalBtn' and 'deleteBtn' click listeners are correct) ...
    });

    // -- Definitive Handler for Create/Edit Form Submission --
    document.body.addEventListener('submit', function(event) {
        const form = event.target.closest('.ajax-form');
        if (!form) return;
        
        event.preventDefault(); // Always prevent the default browser submission
        
        console.log("AJAX form submission initiated."); // DEBUG: Confirm the handler is running

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;

        // IMPORTANT: Manually update the textarea from CKEditor
        const ckeditorTextarea = form.querySelector('textarea.ckeditor-textarea');
        if (ckeditorTextarea && ckeditorTextarea.ckeditorInstance) {
            console.log("Syncing data from CKEditor instance."); // DEBUG
            ckeditorTextarea.value = ckeditorTextarea.ckeditorInstance.getData();
        }

        const formData = new FormData(form);
        console.log("Submitting form data to:", form.action); // DEBUG

        fetch(form.action, {
            method: 'POST',
            body: formData,
            // We need the CSRF token for POST requests
            headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json, text/html' }
        })
        .then(response => {
            console.log("Received response from server with status:", response.status); // DEBUG
            // Your Django views redirect on success. This is the primary success check.
            if (response.redirected) {
                console.log("Response was a redirect. Reloading page."); // DEBUG
                window.location.href = response.url;
                return; // Stop processing
            }
            
            // If it's not a redirect, it's either an error or a JSON success message (from our API views)
            if (response.ok) {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        console.log("Received successful JSON response:", data); // DEBUG
                        // This handles success from our simple API views (like reordering)
                        // In this case, we might just reload for simplicity
                        window.location.reload();
                    });
                }
            }

            // If we reach here, it's a validation error (response.ok is false, or not a redirect)
            console.log("Response is not a redirect or OK. Assuming validation error."); // DEBUG
            // We expect the body of the response to be the re-rendered form HTML with errors
            return response.text().then(html => {
                // Throwing an error here sends it to the .catch() block
                throw new Error(html);
            });
        })
        .catch(error => {
            // This .catch() block handles both network errors and the thrown validation error
            console.log("Caught an error during form submission. Re-rendering modal with error HTML."); // DEBUG
            const modalContent = form.closest('.modal-content');
            if (modalContent) {
                modalContent.innerHTML = error.message; // The error message IS the HTML
                reinitializeModalScripts(modalContent); // IMPORTANT: Re-init JS on the new form content
            }
        });
    });
    
    // -- Definitive Handler for the Delete Form --
    document.getElementById('deleteForm').addEventListener('submit', function(event) {
        event.preventDefault();
        fetch(this.action, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    alert('Error: Could not delete the item.');
                }
            });
    });

    // --- AI Assist Button Logic using EVENT DELEGATION ---
    if (AI_IS_CONFIGURED) {
        document.body.addEventListener('click', function(event) {
            // Check if the clicked element is our AI button
            if (event.target.matches('.ai-assist-btn')) {
                const button = event.target;
                const promptSourceType = button.dataset.promptSource;
                let promptText;

                if (promptSourceType === 'static') {
                    promptText = button.dataset.prompt;
                } else {
                    const promptTextarea = document.getElementById(promptSourceType);
                    if (!promptTextarea) { console.error('AI prompt source not found'); return; }
                    promptText = promptTextarea.value;
                }
                
                const targetElementId = button.dataset.target;
                const contextText = button.dataset.context;
                const targetElement = document.getElementById(targetElementId);
                
                if (!promptText.trim() || !targetElement) { console.error('AI target or prompt is missing'); return; }
                
                const originalButtonText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Thinking...`;
                
                const formData = new FormData();
                formData.append('prompt', promptText);
                formData.append('context', contextText);
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'lsalms:api_ai_assist' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData,
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (!ok) { throw new Error(data.error || 'Server error'); }
                    if (targetElement.nodeName === 'TEXTAREA' || targetElement.nodeName === 'INPUT') {
                        targetElement.value = data.generated_text;
                    } else {
                        const items = data.generated_text.split('\n').filter(item => item.trim() !== '');
                        let html = '<ul class="list-unstyled">';
                        items.forEach(item => {
                            html += `<li><i class="fas fa-check-circle text-success me-2"></i>${item.trim()}</li>`;
                        });
                        html += '</ul>';
                        targetElement.innerHTML = html;
                    }
                })
                .catch(error => { alert(`An AI error occurred: ${error.message}`); })
                .finally(() => { button.disabled = false; button.innerHTML = originalButtonText; });
            }
        });
    }

});
</script>
{% endblock %}