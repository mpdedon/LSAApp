{% load crispy_forms_tags lsalms_extras %}

{{ form.media }}

<!-- We attach the Alpine component to a wrapper div, NOT the form, for stability -->
<div x-data="{ selectedType: '{{ form.instance.content_type|default:'TEXT' }}' }">
    <form class="ajax-form" method="post" action="{{ form_action_url }}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">...</div>
        <div class="modal-body">
            
            {% if form.instance|model_name == 'contentblock' %}
                {{ form.title|as_crispy_field }}
                <div class="mb-3">
                    <label class="form-label requiredField">{{ form.content_type.label }}</label>
                    <select name="{{ form.content_type.name }}" class="form-select" @change="selectedType = $event.target.value">
                        {% for value, text in form.fields.content_type.choices %}
                            <option value="{{ value }}" {% if form.instance.content_type == value %}selected{% endif %}>{{ text }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr>

            <!-- These divs will now correctly show/hide based on the dropdown selection -->
            <div x-show="selectedType === 'TEXT'" x-transition.opacity>{{ form.rich_text|as_crispy_field }}</div>
            <div x-show="selectedType === 'IMAGE' || selectedType === 'AUDIO' || selectedType === 'FILE'" x-transition.opacity>{{ form.media_file|as_crispy_field }}</div>
            <div x-show="selectedType === 'VIDEO'" x-transition.opacity>{{ form.media_url|as_crispy_field }}</div>
            <div x-show="selectedType === 'PRACTICE_QUIZ'" x-transition.opacity>{{ form.linked_practice_quiz|as_crispy_field }}</div>
            <div x-show="selectedType === 'ASSIGNMENT'" x-transition.opacity>{{ form.linked_assignment|as_crispy_field }}</div>
            <div x-show="selectedType === 'ASSESSMENT'" x-transition.opacity>{{ form.linked_assessment|as_crispy_field }}</div>
            <div x-show="selectedType === 'EXAM'" x-transition.opacity>{{ form.linked_exam|as_crispy_field }}</div>
        
        {% else %}
            <!-- Fallback for any other form types -->
            {{ form|crispy }}
        {% endif %}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
</form>