{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Create New Exam{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white text-center"> {# Changed color for Exams #}
            <h2>Create New Exam</h2>
        </div>
        <div class="card-body p-4">
            {% if form.errors or question_errors %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Errors Found!</h4>
                    <p>Please correct the errors below and try again.</p>
                    <hr>
                    {% for field in form %}{% if field.errors %}<p class="mb-0"><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</p>{% endif %}{% endfor %}
                    {% if question_errors %}
                        <p class="mt-2 mb-0"><strong>Question Errors:</strong></p>
                        <ul>{% for error in question_errors %}<li>{{ error }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            {% endif %}

            <form method="POST" novalidate>
                {% csrf_token %}
                
                <div class="row"><div class="col-md-8 mb-3">{{ form.title|as_crispy_field }}</div><div class="col-md-4 mb-3">{{ form.term|as_crispy_field }}</div></div>
                <div class="mb-3">{{ form.short_description|as_crispy_field }}</div>
                <div class="row"><div class="col-md-6 mb-3">{{ form.class_assigned|as_crispy_field }}</div><div class="col-md-6 mb-3">{{ form.subject|as_crispy_field }}</div></div>
                <div class="row"><div class="col-md-6 mb-3">{{ form.due_date|as_crispy_field }}</div><div class="col-md-6 mb-3">{{ form.duration|as_crispy_field }}</div></div>
                <div class="row mt-3">
                    <div class="col-md-6 mb-3">
                        {{ form.result_field_mapping|as_crispy_field }}
                        <small class="form-text text-muted mt-1">Selecting a result field will map this exam's total score into that term result. The score is scaled to the target field's maximum (for example, continuous assessments → Max 10; exams → Max 40). Choose "None" to leave this exam unmapped.</small>
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-center pt-4">
                        <div class="form-check">
                            {{ form.shuffle_questions }}
                            <label class="form-check-label" for="{{ form.shuffle_questions.id_for_label }}">
                                Randomize question & option order for each student?
                            </label>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <h4 class="mb-3">Questions</h4>
                <div id="questions-container"></div>
                <div class="text-center my-3">
                    <button type="button" id="add-question-btn" class="btn btn-outline-success"><i class="fas fa-plus-circle me-1"></i> Add Question</button>
                </div>
                <hr class="my-4">
                <div class="text-center">
                    <button type="submit" class="btn btn-danger btn-lg"><i class="fas fa-save me-1"></i> Save Exam</button>
                    <a href="{{ request.META.HTTP_REFERER|default:'home' }}" class="btn btn-secondary btn-lg">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let questionCount = 0; 

    const createQuestionCardHTML = (qCount) => {
        // Using the 'question_' prefix which the backend helper function expects
        return `
            <div class="card mb-3 shadow-sm question-card-dynamic" id="question-card-${qCount}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="card-title mb-0">New Question ${qCount}</h6>
                        <button type="button" class="btn btn-danger btn-sm remove-question-btn" data-question-id="${qCount}"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="row"><div class="col-md-12 mb-2">
                        <label class="form-label form-label-sm">Type</label>
                        <select name="question_type_${qCount}" class="form-select form-select-sm question-type-select" data-question-id="${qCount}">
                            <option value="SCQ" selected>Single Choice</option><option value="MCQ">Multiple Choice</option><option value="ES">Essay</option>
                        </select>
                    </div></div>
                    <div class="mb-2"><label class="form-label form-label-sm">Question Text</label><textarea name="question_text_${qCount}" class="form-control form-control-sm" rows="2" required></textarea></div>
                    <div class="mb-2 options-container"><label class="form-label form-label-sm">Options (comma-separated)</label><input type="text" name="question_options_${qCount}" class="form-control form-control-sm"></div>
                    <div class="mb-2 correct-answer-scq-mcq-container"><label class="form-label form-label-sm">Correct Answer (SCQ/MCQ)</label><input type="text" name="question_correct_answer_${qCount}" class="form-control form-control-sm"></div>
                    <div class="mb-2 d-none points-container">
                        <label class="form-label form-label-sm">Points (for Essay)</label>
                        <input type="number" name="question_points_vis_${qCount}" class="form-control form-control-sm points-field" min="1">
                        <input type="hidden" name="question_points_${qCount}" id="question_points_${qCount}_hidden" value="">
                    </div>
                </div>
            </div>
        `;
    };

    const toggleQuestionFieldsVisibility = (qId) => {
        const typeSelect = document.querySelector(`.question-card-dynamic[id="question-card-${qId}"] .question-type-select`);
        if (!typeSelect) return;
        const selectedType = typeSelect.value;

        const cardElement = document.getElementById(`question-card-${qId}`);
        if (!cardElement) return;

        const optionsDiv = cardElement.querySelector('.options-container');
        const scqMcqAnswerDiv = cardElement.querySelector('.correct-answer-scq-mcq-container');
        const pointsDiv = cardElement.querySelector('.points-container');
        const pointsInput = cardElement.querySelector('.points-field');
        
        if (!optionsDiv || !scqMcqAnswerDiv || !pointsDiv || !pointsInput) {
            console.error(`Could not find all required field containers for card ID: question-card-${qId}`);
            return;
        }

        if (selectedType === 'ES') {
            optionsDiv.classList.add('d-none');
            scqMcqAnswerDiv.classList.add('d-none');
            pointsDiv.classList.remove('d-none');
            pointsInput.disabled = false;
        } else { // SCQ or MCQ
            optionsDiv.classList.remove('d-none');
            scqMcqAnswerDiv.classList.remove('d-none');
            pointsDiv.classList.add('d-none');
            pointsInput.disabled = true;
        }
    };

    document.getElementById('add-question-btn').addEventListener('click', () => {
        questionCount++;
        document.getElementById('questions-container').insertAdjacentHTML('beforeend', createQuestionCardHTML(questionCount));
        toggleQuestionFieldsVisibility(questionCount);
        const newTypeSelect = document.querySelector(`#question-card-${questionCount} .question-type-select`);
        if (newTypeSelect) {
            newTypeSelect.addEventListener('change', () => toggleQuestionFieldsVisibility(questionCount));
        }
        // Sync visible points input to hidden field so value is submitted reliably
        const visPoints = document.querySelector(`#question-card-${questionCount} input[name="question_points_vis_${questionCount}"]`);
        const hiddenPoints = document.getElementById(`question_points_${questionCount}_hidden`);
        if (visPoints && hiddenPoints) {
            visPoints.addEventListener('input', () => { hiddenPoints.value = visPoints.value; });
        }
    });

    document.getElementById('questions-container').addEventListener('click', function(event) {
        let target = event.target.closest('.remove-question-btn');
        if (target) {
            document.getElementById(`question-card-${target.dataset.questionId}`).remove();
        }
    });

    // Hydration: re-create posted questions if provided by server
    {% if posted_questions_json %}
    try {
        const posted = JSON.parse(`{{ posted_questions_json|escapejs }}`);
        if (Array.isArray(posted)) {
            posted.forEach(pq => {
                document.getElementById('add-question-btn').click();
                const idx = pq.index;
                const typeEl = document.querySelector(`#question-card-${idx} .question-type-select`);
                const textEl = document.querySelector(`#question-card-${idx} textarea[name="question_text_${idx}"]`);
                const optionsEl = document.querySelector(`#question-card-${idx} input[name="question_options_${idx}"]`);
                const correctEl = document.querySelector(`#question-card-${idx} input[name="question_correct_answer_${idx}"]`);
                const visPoints = document.querySelector(`#question-card-${idx} input[name="question_points_vis_${idx}"]`);
                const hiddenPoints = document.getElementById(`question_points_${idx}_hidden`);

                if (typeEl && pq.question_type) typeEl.value = pq.question_type;
                if (textEl && pq.question_text) textEl.value = pq.question_text;
                if (optionsEl && pq.options) optionsEl.value = pq.options.join(', ');
                if (correctEl && pq.correct_answer) correctEl.value = pq.correct_answer;
                if (visPoints && hiddenPoints) { visPoints.value = pq.points || ''; hiddenPoints.value = pq.points || ''; }

                if (typeEl) { typeEl.dispatchEvent(new Event('change')); }
            });
        }
    } catch (e) {
        console.error('Failed to hydrate posted questions (exam):', e);
    }
    {% endif %}
});
</script>
{% endblock %}